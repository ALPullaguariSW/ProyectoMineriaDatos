name: Security Pipeline (SEMMA)

on:
  push:
    branches: [ "main", "test" ]
  pull_request:
    branches: [ "main", "test" ]

jobs:
  security-pipeline:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      PYTHONPATH: src

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸš€ Notify Pipeline Start
      if: always()
      run: python src/notifications.py "ğŸš€ Pipeline Started for commit ${{ github.sha }}"

    - name: ğŸ§  Train Model (Simulation)
      run: |
        python src/data_loader.py
        python src/train_model.py

    - name: ğŸ›¡ï¸ Security Scan (Phase 1)
      id: scan
      run: |
        python src/predict.py src/ > scan_output.txt
        cat scan_output.txt
        if grep -q "\[VULNERABLE\]" scan_output.txt; then
          echo "Vulnerabilities found!"
          exit 1
        fi

    - name: ğŸ“Š Generate Explanations (SHAP)
      if: success()
      run: |
        python src/explain.py
        
    - name: ğŸ“¤ Upload Reports
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          scan_report.json
          reports/figures/shap_summary.png

    - name: âŒ Notify Scan Failure
      if: failure() && steps.scan.outcome == 'failure'
      run: python src/notifications.py "âŒ Security Alert! Vulnerabilities detected in the codebase. Pipeline blocked."

    - name: âœ… Notify Scan Success
      if: success()
      run: python src/notifications.py "âœ… Security Scan Passed. No vulnerabilities found."

    - name: ğŸ§ª Unit Tests (Phase 2)
      run: |
        pytest tests/

    - name: ğŸš€ Deploy to Production (Phase 3)
      if: github.ref == 'refs/heads/main' && success()
      run: |
        echo "Deploying to production..."
        # Add actual deployment commands here (e.g., docker push)
        python src/notifications.py "ğŸš€ Deployment Successful! API is live."
